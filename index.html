<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teeworlds Wiki</title>
    <link rel="shortcut icon" href="resources/teeworlds/teeworlds.ico">
    <link rel="stylesheet" type="text/css" href="resources/style.css">
    <script src="https://unpkg.com/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://unpkg.com/markdown-it-attrs@4.3.1/markdown-it-attrs.browser.js"></script>
    <script src="https://unpkg.com/markdown-it-anchor@9.2.0/dist/markdownItAnchor.umd.js"></script>
    <script src="https://unpkg.com/markdown-it-sub@2.0.0/dist/markdown-it-sub.min.js"></script>
    <script src="https://unpkg.com/markdown-it-sup@2.0.0/dist/markdown-it-sup.min.js"></script>
    <script src="https://unpkg.com/markdown-it-footnote@4.0.0/dist/markdown-it-footnote.min.js"></script>
</head>

<body class="preload">
    <div class="background-dark"></div>
    <div class="background-light"></div>
    <header class="app-bar">
        <div class="app-bar-content">
            <a href="?" class="logo">
                <img src="resources/teeworlds/teeworlds.ico" alt="Teeworlds wiki" width="48" height="48"
                    class="logo-icon">
                <b class="logo-text">Teeworlds Wiki</b>
            </a>
            <div class="nav-buttons">
                <a href="?" class="nav-button">主页</a>
                <a href="?id=about" class="nav-button">关于</a>
            </div>
        </div>
    </header>
    <button class="theme-toggle">🌓</button>
    <div class="container">
        <main>
            <div class="toc-card" id="toc-list"></div>
            <article id="article-card" class="article-card">
                <div id="markdown-content" class="bordered-background">加载中...</div>
            </article>
            <div class="copyleft">
                <b> Copyleft 2025 NewTeeworldsCN <a href="https://github.com/NewTeeworldsCN/teeworlds-wiki"
                        target="_blank">Open source on github</a></b>
            </div>
        </main>
    </div>

    <script>
        // 主题切换逻辑
        let isDark = localStorage.getItem('theme') === 'dark' ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches && !localStorage.getItem('theme'));

        function applyTheme() {
            {
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                if (isDark) {
                    document.body.classList.add('dark-mode');
                }
                else {
                    document.body.classList.remove("dark-mode");
                }
                document.querySelector('.theme-toggle').textContent = isDark ? '🌞' : '🌓';
            }
        }

        document.querySelector('.theme-toggle').addEventListener('click', () => {
            {
                isDark = !isDark;
                applyTheme();
            }
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            {
                applyTheme();
                setTimeout(() => {
                    document.body.classList.remove('preload');
                }, 1000); // 这里不知道为什么能解决闪烁问题，但是反正能解决了就加上了

                const md = markdownit({
                    html: true,
                    linkify: true,
                    typographer: true
                }).use(markdownItAttrs).use(markdownitSub)
                .use(markdownitSup).use(markdownItAnchor, {
                    permalink: false,
                    level: [2, 3],
                    slugify: (s) => s.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-zA-Z0-9\u4e00-\u9fa5\-_]/g, '')
                }).use(markdownitFootnote);
                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                var docID = urlParams.get('id');

                const defaultImageRenderer = md.renderer.rules.image;

                md.renderer.rules.image = function (tokens, idx, options, env, self) {
                    const token = tokens[idx];
                    const oldAttrs = token.attrs;
                    const tooltip = token.attrGet('tooltip');

                    if (tooltip) {
                        token.attrSet('tooltip', null);

                        const imgHtml = defaultImageRenderer(tokens, idx, options, env, self);

                        token.attrSet('tooltip', tooltip);

                        return `
                        <div class="img-container">
                            ${imgHtml}
                            <span class="custom-tooltip">${md.utils.escapeHtml(tooltip)}</span>
                        </div>
                        `;
                    }

                    return defaultImageRenderer(tokens, idx, options, env, self);
                };

                if (docID == null) {
                    docID = "index";
                }
                const fetchUrl = `docs/${docID}.md`;
                function generateTOC() {
                    const headings = [];
                    const content = document.getElementById('markdown-content');

                    // 提取标题
                    content.querySelectorAll('h2, h3, h4').forEach((h, index) => {
                        if (!h.id) return;

                        const level = parseInt(h.tagName[1], 10) - 1;
                        headings.push({
                            level,
                            text: h.textContent,
                            id: h.id,
                            index: index
                        });
                    });
                    const tocList = document.getElementById('toc-list');

                    tocList.innerHTML = '';
                    let headingItems = [];
                    let stack = [tocList];

                    const expandedState = {};

                    headings.forEach(item => {
                        while (stack.length > item.level) {
                            stack.pop();
                        }

                        let Error = false;
                        while (stack.length < item.level) {
                            const parentLi = headingItems[headingItems.length - 1];
                            if (!parentLi) {
                                Error = true;
                                break;
                            }
                            const newUl = document.createElement('ul');
                            const parentId = parentLi.dataset.id;
                            if (parentId && !expandedState[parentId]) {
                                newUl.style.display = 'none';
                            }
                            parentLi.appendChild(newUl);
                            stack.push(newUl);
                        }
                        if(Error)
                            return;

                        if (expandedState[item.id] === undefined) {
                            expandedState[item.id] = false;
                        }

                        const next = headings[item.index + 1];
                        const hasChildren = next && next.level > item.level;

                        const container = stack[stack.length - 1];
                        const li = document.createElement('li');
                        const link = document.createElement('a');

                        li.dataset.id = item.id;

                        if (hasChildren) {
                            link.textContent = expandedState[item.id] ? `▸ ${item.text}` : `▾ ${item.text}`;
                        } else {
                            link.textContent = `• ${item.text}`;
                        }

                        link.href = `#${item.id}`;
                        link.style.textDecoration = 'none';

                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            const target = document.getElementById(item.id);
                            if (target) {
                                window.scrollTo({
                                    top: target.offsetTop - 10,
                                    behavior: 'smooth'
                                });
                            }

                            if (hasChildren) {
                                expandedState[item.id] = !expandedState[item.id];

                                let childUl = li.querySelector(':scope > ul');
                                if (childUl) {
                                    childUl.style.display = expandedState[item.id] ? 'block' : 'none';
                                }

                                link.textContent = expandedState[item.id] ? `▸ ${item.text}` : `▾ ${item.text}`;
                            }
                        });

                        li.appendChild(link);
                        container.appendChild(li);
                        headingItems.push(li);
                    });
                    if(headingItems.length == 0)
                    {
                        tocList.style.display = 'none';
                        document.getElementById('article-card').style.marginLeft = "10%";
                    }
                }

                fetch(fetchUrl)
                    .then(response => {
                        if (!response.ok) throw new Error("加载失败QAQ?");
                        return response.text();
                    })
                    .then(text => {
                        document.getElementById("markdown-content").innerHTML = md.render(text);
                        generateTOC();
                    })
                    .catch(err => {
                        document.getElementById("markdown-content").innerHTML = `<p style="color:red;">错误：${err.message}</p>`;
                    });
            }
        });
    </script>
</body>

</html>